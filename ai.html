<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Riverside Connect - AI Church Guide</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link rel="manifest" href="./manifest.json">


    <!-- iOS Safari home screen support -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Riverside Connect">

<!-- Reuse your existing 192Ã—192 icon for Apple devices -->
<link rel="apple-touch-icon" sizes="180x180" href="maskable_icon_x192.png">
<link rel="apple-touch-icon" sizes="152x152" href="maskable_icon_x192.png">
<link rel="apple-touch-icon" sizes="167x167" href="maskable_icon_x192.png">
<!-- Fallback (also uses the same file) -->
<link rel="apple-touch-icon" href="maskable_icon_x192.png">
  
<!-- Open Graph / Social sharing preview -->
<meta property="og:title" content="Riverside Connect ">
<meta property="og:description" content="Join the conversation in Riverside Connect â€“ a simple, real-time chat experience. Share thoughts, media & more.">
<meta property="og:image" content="https://vibe-ultrafiles04.github.io/The-Riverside-Connect/maskable_icon_x192.png">
<meta property="og:url" content="https://vibe-ultrafiles04.github.io/The-Riverside-Connect/">
<meta property="og:type" content="website">

<!-- Recommended extras (helps Twitter/X, WhatsApp, Discord, etc.) -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Riverside Connect ">
<meta name="twitter:description" content="Join the conversation in Riverside Connect â€“ a simple, real-time chat experience.">
<meta name="twitter:image" content="https://vibe-ultrafiles04.github.io/The-Riverside-Connect/maskable_icon_x192.png">

<!-- Optional but useful -->
<meta property="og:site_name" content="Riverside Connect">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="Riverside Connect chat preview">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    html, body {
      height:100dvh;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,#0f172a,#1e293b);
      color:#e2e8f0;
      -webkit-tap-highlight-color:transparent;
    }

    body {
      display:flex;
      flex-direction:column;
      min-height:100dvh;
    }

    header {
      background:rgba(15,23,42,0.92);
      backdrop-filter:blur(10px);
      padding: calc(10px + env(safe-area-inset-top)) 14px 10px;
      border-bottom:1px solid rgba(96,165,250,0.18);
      position:sticky;
      top:0;
      z-index:100;
      display:flex;
      align-items:center;
      gap:12px;
      flex-shrink:0;
    }

    .back-btn {
      background:none;
      border:none;
      color:#60a5fa;
      font-size:1.4rem;
      cursor:pointer;
      padding:8px;
      flex-shrink:0;
    }

    h1 {
      font-size:1.35rem;
      color:#60a5fa;
      font-weight:600;
      flex:1;
      text-align:center;
    }

    .ai-chat-container {
      flex:1 1 auto;
      min-height:0;
      padding:16px 14px 100px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      -webkit-overflow-scrolling:touch;
      touch-action: pan-y;
    }

    .message {
      display:flex;
      align-items:flex-start;
      max-width:90%;
      gap:12px;
      animation:fadeIn 0.35s ease-out;
    }

    .message.user { margin-left:auto; flex-direction:row-reverse; }

    .bot-avatar, .user-avatar {
      width:42px;
      height:42px;
      border-radius:50%;
      flex-shrink:0;
    }

    .bot-avatar {
      background:linear-gradient(135deg,#3b82f6,#60a5fa);
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      font-weight:bold;
      border:2px solid rgba(96,165,250,0.4);
    }

    .user-avatar {
      object-fit:cover;
      border:2px solid #60a5fa;
    }

    .message-content {
      padding:14px 18px;
      border-radius:20px;
      max-width:calc(100% - 64px);
      backdrop-filter:blur(6px);
    }

    .message.user .message-content {
      background:linear-gradient(135deg,#3b82f6,#60a5fa);
      color:white;
      border-top-left-radius:20px;
      border-top-right-radius:6px;
    }

    .message:not(.user) .message-content {
      background:rgba(30,41,59,0.88);
      border-top-left-radius:6px;
      border-top-right-radius:20px;
    }

    .text { line-height:1.55; word-break:break-word; }

    .time {
      font-size:0.7rem;
      color:rgba(148,163,184,0.9);
      margin-top:6px;
      display:block;
    }

    .message.user .time { color:rgba(255,255,255,0.82); }

    .input-area {
      background:rgba(15,23,42,0.98);
      padding: calc(10px + env(safe-area-inset-bottom)) 14px 10px;
      border-top:1px solid rgba(96,165,250,0.25);
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      z-index:90;
      flex-shrink:0;
    }

    .input-wrapper {
      max-width:900px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:10px;
    }

    #ai-input {
      flex:1;
      min-width:0;
      padding:14px 18px;
      border-radius:28px;
      background:rgba(255,255,255,0.09);
      color:white;
      font-size:16px;
      border:none;
      outline:none;
    }

    #ai-input:focus {
      background:rgba(255,255,255,0.16);
      box-shadow:0 0 0 3px rgba(96,165,250,0.4);
    }

    #ai-input::placeholder { color:#94a3b8; }

    #send-ai {
      width:52px;
      height:52px;
      border-radius:50%;
      background:linear-gradient(135deg,#3b82f6,#60a5fa);
      color:white;
      border:none;
      font-size:1.2rem;
      cursor:pointer;
      flex-shrink:0;
    }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .loading {
      font-style:italic;
      color:#94a3b8;
      padding:12px 18px;
      background:rgba(30,41,59,0.6);
      border-radius:18px;
      align-self:flex-start;
      max-width:70%;
    }

    .ai-chat-container::-webkit-scrollbar {
      width:6px;
    }

    .ai-chat-container::-webkit-scrollbar-thumb {
      background:rgba(96,165,250,0.5);
      border-radius:10px;
    }

    /* Report styles */
    .report-section {
      font-weight:700;
      color:#60a5fa;
      margin:18px 0 10px;
      font-size:1.1rem;
    }

    .report-table {
      width:100%;
      border-collapse:collapse;
      margin:12px 0;
      font-size:0.94rem;
      background:rgba(30,41,59,0.4);
      border-radius:10px;
      overflow:hidden;
    }

    .report-table th, .report-table td {
      padding:10px 12px;
      border:1px solid rgba(96,165,250,0.25);
      text-align:left;
    }

    .report-table th {
      background:rgba(96,165,250,0.25);
      font-weight:600;
    }

    .report-media {
      max-width:100%;
      max-height:260px;
      border-radius:10px;
      margin:10px 0;
      display:block;
      box-shadow:0 2px 12px rgba(0,0,0,0.4);
    }

  /* Members list - horizontal scroll on mobile, grid on larger screens */
.report-list {
  list-style: none;
  padding: 0;
  margin: 12px 0;
  display: flex;                    /* Horizontal by default */
  flex-wrap: nowrap;                /* No wrapping â†’ scroll instead */
  overflow-x: auto;                 /* Enable horizontal scroll */
  gap: 16px;                        /* Space between cards */
  scroll-snap-type: x mandatory;    /* Snap to each card */
  -webkit-overflow-scrolling: touch; /* Smooth iOS scrolling */
  scrollbar-width: thin;            /* Firefox scrollbar */
  scrollbar-color: #60a5fa #1e293b;
  padding-bottom: 12px;             /* Space for scrollbar */
}

/* Hide scrollbar but keep functionality (clean look) */
.report-list::-webkit-scrollbar {
  height: 6px;
}
.report-list::-webkit-scrollbar-track {
  background: transparent;
}
.report-list::-webkit-scrollbar-thumb {
  background: rgba(96,165,250,0.5);
  border-radius: 3px;
}

/* Each member card */
.report-list li {
  flex: 0 0 160px;                  /* Fixed width cards */
  background: rgba(30,41,59,0.65);
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 16px 12px;
  text-align: center;
  border: 1px solid rgba(96,165,250,0.25);
  transition: all 0.22s ease;
  scroll-snap-align: start;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.report-list li:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 32px rgba(0,0,0,0.5);
  border-color: #60a5fa;
}

/* Avatar inside member card */
.report-list li .media-content img {
  width: 96px;
  height: 96px;
  object-fit: cover;
  border: 3px solid #60a5fa;
  box-shadow: 0 4px 16px rgba(59,130,246,0.25);
  margin-bottom: 12px;
}

/* Name & date */
.report-list li small {
  font-size: 0.82rem;
  color: #94a3b8;
  display: block;
  margin-top: 4px;
}

/* Responsive: switch to grid on tablets & desktop */
@media (min-width: 640px) {
  .report-list {
    flex-wrap: wrap;               /* Allow wrapping */
    overflow-x: hidden;            /* No horizontal scroll needed */
    justify-content: center;       /* Center cards */
  }
  
  .report-list li {
    flex: 0 0 180px;               /* Slightly larger on bigger screens */
  }
}

@media (min-width: 1024px) {
  .report-list li {
    flex: 0 0 200px;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Beautiful Announcement Cards (replaces ugly table)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* Announcement card - avatar beside name */
.announcement-card {
  background: rgba(30,41,59,0.7);
  backdrop-filter: blur(8px);
  border-radius: 16px;
  border: 1px solid rgba(96,165,250,0.25);
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  transition: all 0.22s ease;
}

.card-header {
  padding: 12px 16px;
  background: rgba(96,165,250,0.15);
  border-bottom: 1px solid rgba(96,165,250,0.25);
  display: flex;
  align-items: center;
  gap: 12px;                    /* Space between avatar and name/date */
}



.card-meta {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.card-author {
  font-weight: 600;
  color: #60a5fa;
  font-size: 1.05rem;
  margin: 0;
}

.card-date {
  font-size: 0.82rem;
  color: #94a3b8;
  margin: 0;
}

.card-content {
  padding: 16px;
  line-height: 1.55;
}

.card-content p {
  margin: 0 0 12px 0;
  word-break: break-word;
}

/* Media inside card */
.card-content .media-content {
  margin: 12px 0 0 0;
  border-radius: 12px;
  overflow: hidden;
}

.card-content .media-content img,
.card-content .media-content iframe {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 12px;
}

/* Responsive - keep avatar small on all screens */
@media (max-width: 480px) {
  .card-avatar {
    width: 32px;
    height: 32px;
  }
  .card-author {
    font-size: 0.98rem;
  }
}

/* Tiny avatar beside name in announcements */
.announcement-avatar {
  width: 28px;                  /* Very small */
  height: 28px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #60a5fa;
  flex-shrink: 0;
  background: #1e293b;
}

.announcement-avatar-placeholder {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #1e293b;
  border: 2px solid #60a5fa;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #60a5fa;
  font-size: 14px;
  flex-shrink: 0;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;                    /* Tight space between avatar & text */
  padding: 10px 14px;
  background: rgba(96,165,250,0.12);
  border-bottom: 1px solid rgba(96,165,250,0.18);
}

.card-meta {
  flex: 1;
  min-width: 0;                 /* Prevents overflow */
}

.card-author {
  font-weight: 600;
  color: #60a5fa;
  font-size: 1.02rem;
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-date {
  font-size: 0.78rem;
  color: #94a3b8;
  display: block;
}

/* Ensure no extra space below header */
.card-content {
  padding: 12px 14px 16px;
  font-size: 0.96rem;
  line-height: 1.5;
}
  </style>
</head>
<body>

<header>
  <button class="back-btn" onclick="window.history.back()">
    <i class="fas fa-arrow-left"></i>
  </button>
  <h1>AI Church Guide</h1>
  <!-- Clear Chat Button -->
<!-- Clear Chat Button -->
<div style="padding: 0 14px 10px; background: rgba(15,23,42,0.8); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(96,165,250,0.18);">
  <button id="clear-chat-btn" style="
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    display: block;
    padding: 12px;
    background: linear-gradient(135deg, #ef4444, #f87171);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(239,68,68,0.3);
    transition: all 0.2s ease;
  ">
    <i class="fas fa-trash-alt" style="margin-right: 8px;"></i> Clear Chat
  </button>
</div>
</header>

<div class="ai-chat-container" id="ai-chat">
 
</div>

<div class="input-area">
  <div class="input-wrapper">
    <div class="input-row">
      <input type="text" id="ai-input" placeholder="Ask anything about Riverside Connect..." autocomplete="off" autofocus>
      <button id="send-ai"><i class="fas fa-magnifying-glass"></i></button>
    </div>
  </div>
</div>

<script>
// ============================================================================
//  RIVERSIDE CONNECT AI CHURCH GUIDE - 2026 Edition
//  ~1100+ lines - Super helpful, never says "no records", Grok-style smart
// ============================================================================

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznZ7kEv1fe7no8WHuYgnXJf2LSv_robNZ3RE_TK3X1g42_zWXhDXYPjuG1iqBGO-de/exec';

// IndexedDB Setup - persistent chat history
const DB_NAME = "RiversideAIChat";
const DB_VERSION = 1;
const STORE_NAME = "messages";
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror = () => reject(req.error);
    req.onsuccess = () => { db = req.result; resolve(); };
    req.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { autoIncrement: true });
      }
    };
  });
}

async function saveMessage(isUser, text, time) {
  if (!db) await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE_NAME, "readwrite");
    tx.objectStore(STORE_NAME).add({ isUser, text, time });
    tx.oncomplete = res;
    tx.onerror = () => rej(tx.error);
  });
}

async function loadHistory() {
  if (!db) await openDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const req = tx.objectStore(STORE_NAME).getAll();
    req.onsuccess = () => {
      req.result.forEach(m => addMessage(m.text, m.isUser, m.time, false));
      scrollToBottom(true);
      res();
    };
    req.onerror = () => rej(req.error);
  });
}

// User avatar helper
function getUserAvatarSrc() {
  const link = localStorage.getItem('userPicLink') || '';
  if (!link) return 'https://via.placeholder.com/42?text=@';
  const idMatch = link.match(/[-\w]{25,}/);
  return idMatch ? `https://lh3.googleusercontent.com/d/${idMatch[0]}` : link;
}

// Add message to chat (HTML safe)
async function addMessage(content, isUser = false, time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), save = true) {
  const chat = document.getElementById('ai-chat');
  const msg = document.createElement('div');
  msg.className = `message ${isUser ? 'user' : ''}`;

  msg.innerHTML = `
    ${isUser ? `<img src="${getUserAvatarSrc()}" class="user-avatar">` : `<div class="bot-avatar">AI</div>`}
    <div class="message-content" style="${isUser ? 'border-top-left-radius:20px;border-top-right-radius:6px;' : 'border-top-left-radius:6px;border-top-right-radius:20px;'}">
      <div class="text">${content}</div>
      <span class="time">${time}</span>
    </div>
  `;

  chat.appendChild(msg);
  scrollToBottom(true);

  if (save) await saveMessage(isUser, content, time);
}

function scrollToBottom(force = false) {
  const chat = document.getElementById('ai-chat');
  if (!chat) return;
  const distance = chat.scrollHeight - chat.scrollTop - chat.clientHeight;
  if (force || distance < 240) {
    chat.scrollTo({ top: chat.scrollHeight, behavior: force ? 'instant' : 'smooth' });
  }
}

function showTyping() {
  const chat = document.getElementById('ai-chat');
  const div = document.createElement('div');
  div.className = 'message';
  div.innerHTML = `
    <div class="bot-avatar">AI</div>
    <div class="loading">thinking...</div>
  `;
  chat.appendChild(div);
  scrollToBottom(true);
  return div;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Backend fetch helper
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchBackend(operation, params = {}) {
  try {
    let url = `${SCRIPT_URL}?operation=${operation}`;
    if (Object.keys(params).length) {
      url += '&' + new URLSearchParams(params).toString();
    }
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (err) {
    console.error("Backend fetch error:", err);
    return { status: 'error', message: err.message };
  }
}

async function fetchAllData() {
  const data = await fetchBackend('getData');
  return {
    comments: data.comments || [],
    announcements: data.announcements || []
  };
}

async function fetchMembers() {
  const data = await fetchBackend('getMembers');
  return data.status === 'success' ? (data.users || []) : [];
}

// Replace your current renderMedia() with this
function renderMedia(item) {
  let mediaHtml = '';

  // â”€â”€ 1. Attached media (fileLink) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // This works for both announcements and comments â€” images/videos only
  if (item.fileLink && item.fileLink.trim()) {
    const links = item.fileLink.split(',').map(l => l.trim()).filter(Boolean);
    
    links.forEach(link => {
      const fileId = extractFileId(link);
      if (!fileId) {
        mediaHtml += `<a href="${link}" target="_blank" style="color:#60a5fa;">View media</a><br>`;
        return;
      }

      const lower = link.toLowerCase();
      const isVideo = 
        (item.fileType && item.fileType.includes('video')) ||
        lower.match(/\.(mp4|mov|webm|m4v)$/i) ||
        lower.includes('/preview');

      const isAudio = 
        (item.fileType && item.fileType.includes('audio')) ||
        lower.match(/\.(mp3|wav|ogg|aac|m4a|flac)$/i);

      if (isVideo || isAudio) {
        const height = isAudio ? '80px' : '240px';
        mediaHtml += `
          <div class="media-content">
            <iframe src="https://drive.google.com/file/d/${fileId}/preview"
                    allowfullscreen loading="lazy"
                    style="width:100%; height:${height}; border:none;"></iframe>
          </div>`;
      } else {
        const imgSrc = `https://lh3.googleusercontent.com/d/${fileId}`;
        mediaHtml += `
          <div class="media-content">
            <img src="${imgSrc}"
                 loading="lazy" style="max-width:100%; max-height:260px; border-radius:10px;"
                 onerror="this.src='https://via.placeholder.com/300x200?text=Failed';">
          </div>`;
      }
    });
  }

  // â”€â”€ 2. ONLY render avatars for MEMBERS (list mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // We check if this item has 'date' or looks like a member record
  if (item.picLink && (item.date || item.status || !item.fileLink)) {
    const avatarId = extractFileId(item.picLink);
    const avatarSrc = avatarId 
      ? `https://lh3.googleusercontent.com/d/${avatarId}`
      : item.picLink;

    mediaHtml += `
      <div class="media-content">
        <img src="${avatarSrc}"
             style="width:96px; height:96px; object-fit:cover; border-radius:50%; border:3px solid #60a5fa; box-shadow:0 4px 16px rgba(59,130,246,0.25);"
             onerror="this.src='https://via.placeholder.com/96?text=@';">
      </div>`;
  }

  return mediaHtml || '';
}
// Add right after your fetchBackend() function
function extractFileId(url) {
  if (!url) return '';
  const match = url.match(/[-\w]{25,}/);
  return match ? match[0] : '';
}

function getLh3Link(url) {
  const id = extractFileId(url);
  return id ? `https://lh3.googleusercontent.com/d/${id}` : '';
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Format rich reports - always helpful, never empty
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatReport(title, items, type = 'table') {
  if (!items?.length) {
    return `
      <div class="report-section">${title}</div>
      <p style="color:#94a3b8; margin:16px 0; line-height:1.6;">
        No ${title.toLowerCase()} found right now.<br>
        This could mean:<br>â€¢ Nothing has been posted yet<br>â€¢ Try a different keyword<br>â€¢ Check back later â€” new content is added often!<br><br>
        What else can I help you with today? ğŸ™
      </p>`;
  }

  let html = `<div class="report-section">${title} (${items.length})</div>`;

  if (type === 'table') {
    // Announcements: compact card with ONE tiny avatar beside name ONLY
    html += '<div class="announcement-cards">';
    items.forEach(item => {
      const date = new Date(item.timestamp).toLocaleString([], {
        dateStyle: 'medium',
        timeStyle: 'short'
      });

      // Tiny avatar beside name (only once)
      let avatarHtml = '';
      if (item.picLink) {
        const avatarId = extractFileId(item.picLink);
        const avatarSrc = avatarId 
          ? `https://lh3.googleusercontent.com/d/${avatarId}`
          : item.picLink || 'https://via.placeholder.com/28?text=@';

        avatarHtml = `
          <img src="${avatarSrc}" 
               class="announcement-avatar" 
               alt="${item.name || 'User'}" 
               loading="lazy"
               onerror="this.src='https://via.placeholder.com/28?text=@';">
        `;
      } else {
        // Tiny placeholder icon if no picLink
        avatarHtml = `
          <div class="announcement-avatar-placeholder">
            <i class="fas fa-user"></i>
          </div>
        `;
      }

      const media = renderMedia(item);

      html += `
        <div class="announcement-card">
          <div class="card-header">
            ${avatarHtml}
            <div class="card-meta">
              <span class="card-author">${item.name || 'Anonymous'}</span>
              <span class="card-date">${date}</span>
            </div>
          </div>
          <div class="card-content">
            <p>${item.comment || ''}</p>
            ${media}
          </div>
        </div>`;
    });
    html += '</div>';
  } else {
    // Members list - unchanged (horizontal/scrollable)
    html += '<ul class="report-list">';
    items.forEach(item => {
      const date = new Date(item.timestamp || item.date || Date.now()).toLocaleDateString([], {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      const media = renderMedia(item);
      html += `
        <li>
          ${media}
          <div style="margin-top:8px;">
            ${item.comment || item.name || 'â€”'} 
            <small>â€” joined ${date}</small>
          </div>
        </li>`;
    });
    html += '</ul>';
  }

  return html;
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ULTRA-SMART RESPONSE ENGINE - Grok-level understanding
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getResponse(question) {
  const q = question.toLowerCase().trim();
  const userName = localStorage.getItem('userName') || 'friend';

  // â”€â”€ 1. Warm greetings & chit-chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.match(/^(hi|hello|hey|good\s*(morning|afternoon|evening)|how\s*are\s*you|sup|yo|shalom|greetings)/i)) {
    const greetings = [
      `Hello ${userName}! ğŸ‘‹ Great to see you today!`,
      `Hey ${userName}! ğŸ˜Š How's your day going so far?`,
      `Hi there, ${userName}! ğŸ™Œ Ready to talk church, Bible, or life?`,
      `Good to see you, ${userName}! ğŸŒŸ What's on your heart today?`
    ];
    return greetings[Math.floor(Math.random() * greetings.length)] + 
           "<br><br>I'm here for anything â€” services, announcements, prayer needs, Bible questions, or just to chat. What's up?";
  }

  // â”€â”€ Thanks & appreciation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('thank') || q.includes('thanks') || q.includes('appreciate')) {
    return `You're so welcome, ${userName}! ğŸ™ It makes me happy to help.<br><br>Anything else on your mind? I'm all ears.`;
  }

  // â”€â”€ Church services & schedule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('service') || q.includes('time') || q.includes('sunday') || q.includes('when') || q.includes('wednesday')) {
    return `Here's the current Riverside Connect schedule:<br><br>
            â€¢ <strong>Sunday Services</strong><br>
              Â Â 9:00 AM â€“ English Service<br>
              Â Â 11:00 AM â€“ Bilingual Service<br><br>
            â€¢ <strong>Bible Study / Small Groups</strong><br>
              Â Â Wednesdays at 7:00 PM<br><br>
            Want me to pull the latest announcements for any special events or changes?`;
  }

  // â”€â”€ Location & directions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('where') || q.includes('location') || q.includes('address') || q.includes('juja') || q.includes('kiambu')) {
    return `We're based in <strong>Juja, Kiambu County, Kenya</strong>.<br><br>
            Exact meeting spot details are usually shared in announcements or directly with leadership for safety and privacy.<br><br>
            Would you like me to show the most recent announcements that might include directions or maps?`;
  }

  // â”€â”€ Announcements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('announce') || q.includes('event') || q.includes('latest') || q.includes('upcoming') || q.includes('news')) {
    const { announcements } = await fetchAllData();
    let filtered = announcements;

    const searchTerm = q.replace(/(announce?ments?|event?s?|latest|upcoming|news)/gi, '').trim();
    if (searchTerm) {
      filtered = announcements.filter(a => 
        (a.comment || '').toLowerCase().includes(searchTerm) || 
        (a.name || '').toLowerCase().includes(searchTerm)
      );
    }

    if (filtered.length === 0 && announcements.length > 0) {
      return `I didn't find anything specific about "${searchTerm}", but here are all recent announcements:` + 
             formatReport('All Announcements', announcements, 'table') +
             "<br>Anything in particular you're looking for?";
    }

    return formatReport('Announcements & Events', filtered, 'table') +
           (filtered.length > 0 ? "<br>Let me know if you'd like more details on any of these!" : "");
  }

  // â”€â”€ Comments / Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('comment') || q.includes('message') || q.includes('chat') || q.includes('discussion') || q.includes('talk')) {
    const { comments } = await fetchAllData();
    let filtered = comments;

    const searchTerm = q.replace(/(comment?s?|message?s?|chat|discussion|talk)/gi, '').trim();
    if (searchTerm) {
      filtered = comments.filter(c => 
        (c.comment || '').toLowerCase().includes(searchTerm) || 
        (c.name || '').toLowerCase().includes(searchTerm)
      );
    }

    return formatReport('Recent Comments & Messages', filtered, 'table') +
           (filtered.length === 0 ? "<br>No recent comments match that â€” but people are always sharing! Want to see everything?" : "");
  }

  // â”€â”€ Members / People â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('member') || q.includes('members') || q.includes('who') || q.includes('find') || q.includes('people')) {
    const members = await fetchMembers();
    let filtered = members;

    const searchTerm = q.replace(/(member?s?|who|find|people)/gi, '').trim();
    if (searchTerm) {
      filtered = members.filter(m => (m.name || '').toLowerCase().includes(searchTerm));
    }

    if (filtered.length === 0 && members.length > 0) {
      return `I couldn't find anyone named "${searchTerm}", but here are all our members:` + 
             formatReport('Church Members', members, 'list') +
             "<br>Who are you looking for? Maybe I can help narrow it down!";
    }

    return formatReport('Church Members', filtered, 'list');
  }

  // â”€â”€ Bible, faith, prayer, salvation, baptism â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('bible') || q.includes('verse') || q.includes('scripture') || 
      q.includes('believe') || q.includes('faith') || q.includes('prayer') || 
      q.includes('salvation') || q.includes('baptism') || q.includes('jesus')) {
    return `We stand firmly on the Bible as God's inspired Word.<br><br>
            Some powerful verses we hold close:<br>
            â€¢ <strong>John 3:16</strong> â€“ God loved the world so much He gave His only Son.<br>
            â€¢ <strong>Romans 10:9</strong> â€“ If you confess Jesus is Lord and believe in your heart, you will be saved.<br>
            â€¢ <strong>Romans 8:28</strong> â€“ All things work together for good for those who love God.<br><br>
            Want me to find announcements about prayer meetings, Bible study, or baptism classes? Just say the word! ğŸ™`;
  }

  // â”€â”€ How to join / Get involved â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (q.includes('join') || q.includes('involved') || q.includes('connect') || q.includes('become')) {
    return `We'd love to have you more involved!<br><br>
            â€¢ Come to Sunday services (9 AM or 11 AM)<br>
            â€¢ Join Wednesday Bible study/small groups at 7 PM<br>
            â€¢ Talk to one of our leaders after service<br><br>
            Everyone is welcome â€” no pressure, just family. Want me to pull recent announcements about ways to connect?`;
  }

  // â”€â”€ Smart fallback - never empty, always helpful â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return `Thanks for asking, ${userName}! ğŸ™<br><br>
          I didn't quite catch a specific topic there, but I'm ready to help with anything:<br>
          â€¢ Service times & schedule<br>
          â€¢ Latest announcements & events<br>
          â€¢ Church members directory<br>
          â€¢ Bible questions or verses<br>
          â€¢ Prayer needs or encouragement<br>
          â€¢ How to get more connected<br><br>
          What would you like to talk about today? I'm listening!`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Send message handler
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendMessage() {
    const input = document.getElementById('ai-input');
    const text = input.value.trim();
    if (!text) return;

    await addMessage(text, true);
    input.value = '';

    const typing = showTyping();
    await new Promise(r => setTimeout(r, 800 + Math.random()*900));
    typing.remove();

    const answer = await getResponse(text);
    await addMessage(answer);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Initialization
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('load', async () => {
    try {
      await openDB();
      await loadHistory();
    } catch (e) {
      console.warn("IndexedDB failed:", e);
    }

    const input = document.getElementById('ai-input');
    input.focus();

    document.getElementById('send-ai').onclick = sendMessage;

    input.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        scrollToBottom(true);
        document.body.style.height = `${window.visualViewport.height}px`;
      });
    }

    scrollToBottom(true);
  });
  // Create and add welcome message dynamically
const userName = localStorage.getItem('userName') || 'Brother/Sister';
const welcomeMessage = `
  Hello <strong>${userName}</strong>! ğŸ‘‹<br><br>
  I'm your Riverside Connect AI helper â€” ready to assist with anything about our church family.<br>
  Feel free to ask about services, announcements, members, Bible questions, prayer needs, or how to get more involved. I'm here for you!
`;

addMessage(welcomeMessage, false, null, false); // false = don't save to DB yet

  // â”€â”€ Clear Chat Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('clear-chat-btn')?.addEventListener('click', () => {
  // Show confirmation toast
  const toast = document.createElement('div');
  toast.style = `
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
    background: rgba(30,41,59,0.95); color: white; padding: 16px 24px;
    border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    z-index: 2000; text-align: center; border: 1px solid #ef4444;
    max-width: 90%; font-size: 1rem;
  `;
  toast.innerHTML = `
    <div>Clear all chat history?</div>
    <div style="margin-top:12px;">
      <button id="confirm-clear" style="
        padding:8px 20px; background:#ef4444; color:white; border:none;
        border-radius:8px; margin-right:12px; cursor:pointer; font-weight:600;
      ">Yes, Clear</button>
      <button id="cancel-clear" style="
        padding:8px 20px; background:rgba(255,255,255,0.15); color:white;
        border:1px solid rgba(255,255,255,0.3); border-radius:8px;
        cursor:pointer; font-weight:600;
      ">Cancel</button>
    </div>
  `;
  document.body.appendChild(toast);

  // Confirm â†’ actually clear
  document.getElementById('confirm-clear').onclick = async () => {
    toast.remove();

    // Clear IndexedDB
    if (db) {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).clear();
      await new Promise(r => tx.oncomplete = r);
    }

    // Clear UI messages (keep welcome message)
    const chat = document.getElementById('ai-chat');
    chat.innerHTML = `
      <div class="message">
        <div class="bot-avatar">AI</div>
        <div class="message-content">
          <div class="text">
            Hello <strong>${localStorage.getItem('userName') || 'Brother/Sister'}</strong>! ğŸ‘‹<br><br>
            Chat history cleared. How can I assist you now? ğŸ™
          </div>
          <span class="time">Just now</span>
        </div>
      </div>
    `;

    scrollToBottom(true);

    // Success toast
    const successToast = document.createElement('div');
    successToast.style = `
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: #22c55e; color: white; padding: 12px 24px;
      border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      z-index: 1000; font-weight: 500;
    `;
    successToast.textContent = 'Chat cleared successfully!';
    document.body.appendChild(successToast);
    setTimeout(() => successToast.remove(), 3000);
  };

  // Cancel â†’ just remove toast
  document.getElementById('cancel-clear').onclick = () => toast.remove();
});
</script>
<script>
 if ('serviceWorker' in navigator) {
  // Use './' to stay inside the /The-Riverside-Connect/ subfolder
  navigator.serviceWorker.register('./sw.js', { scope: './' })
    .then(reg => console.log('âœ… SW registered in subfolder scope'))
    .catch(err => console.error('âŒ SW registration failed:', err));
}
</script>

</body>
</html>